<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip Planner Pro v21.8 - Final Cloud</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5b7482">
    <link rel="apple-touch-icon" href="icon-512.png">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        :root { --morandi-blue-dark: #5b7482; --morandi-blue-main: #8ba3b0; --morandi-blue-light: #b4c7d1; --morandi-bg: #e9eff2; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--morandi-bg); color: #455a64; touch-action: manipulation; }
        .mist-card { background: white; border-radius: 2rem; border: 1px solid rgba(139, 163, 176, 0.2); box-shadow: 0 10px 30px -10px rgba(91, 116, 130, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [v-cloak] { display: none !important; }
        .day-scroller { display: flex; gap: 0.75rem; overflow-x: auto; padding: 0.5rem 0.25rem; }
        .day-tab { position: relative; flex-shrink: 0; }
        .day-delete { position: absolute; top: -5px; right: -5px; background: #d9a7a7; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid white; z-index: 100; }
        .btn-primary { background-color: var(--morandi-blue-dark); color: white; }
        .sync-height { height: 42px; }
        .split-btn { height: 42px; min-width: 55px; display: flex; align-items: center; justify-content: center; border-radius: 14px; font-size: 12px; font-weight: 700; transition: all 0.3s; }
        .split-active { background-color: var(--morandi-blue-main); color: white; }
        .split-inactive { background-color: #f1f5f7; color: #adb5bd; }
        .nav-morandi { background-color: rgba(91, 116, 130, 0.95); backdrop-filter: blur(10px); }
        .drag-handle { cursor: grab !important; padding: 10px; color: var(--morandi-blue-light); }
        .sortable-ghost { opacity: 0; }
        .glass-modal-overlay { position: fixed; inset: 0; z-index: 6000; background: rgba(233, 239, 242, 0.6); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
        .glass-modal-content { background: rgba(255, 255, 255, 0.8); width: 100%; max-width: 500px; max-height: 85vh; border-radius: 3rem; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 25px 50px -12px rgba(91, 116, 130, 0.2); display: flex; flex-direction: column; overflow: hidden; }
        .attachment-btn { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255,255,255,0.8); border: 1px solid rgba(139, 163, 176, 0.3); color: var(--morandi-blue-main); box-shadow: 0 4px 12px rgba(91, 116, 130, 0.1); }
        .badge-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #d9a7a7; border-radius: 50%; border: 2px solid white; }
        .date-adjust-bar { background: white; border-radius: 1.25rem; padding: 0.5rem 1rem; display: inline-flex; align-items: center; gap: 0.5rem; border: 1px solid rgba(139, 163, 176, 0.3); cursor: pointer; margin-bottom: 1.5rem; }
        .edit-icon { color: #ccd6dd; transition: color 0.3s; cursor: pointer; font-size: 1rem; margin-left: 8px; vertical-align: middle; }
    </style>
</head>
<body class="pb-36">

<div id="app" v-cloak>
    <div v-if="ui.isLoading" class="fixed inset-0 z-[9999] bg-[#e9eff2] flex flex-col items-center justify-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-[#8ba3b0] mb-4"></i>
        <p class="text-sm text-slate-400 font-bold tracking-widest uppercase">載入中...</p>
    </div>

    <div v-else-if="!currentUser" class="fixed inset-0 bg-[#e9eff2] flex flex-col items-center justify-center p-10 text-center">
        <div class="mb-8">
            <i class="fas fa-map-marked-alt text-6xl text-[#5b7482] mb-4"></i>
            <h2 class="text-2xl font-bold text-slate-700">Trip Planner Pro</h2>
            <p class="text-slate-400 mt-2">請登入以同步雲端行程</p>
        </div>
        <button @click="login" class="btn-primary w-full max-w-xs py-4 rounded-3xl font-bold shadow-xl flex items-center justify-center gap-3">
            <i class="fab fa-google"></i> 使用 Google 登入
        </button>
    </div>

    <div v-else>
        <div v-if="ui.showTripNameModal" class="glass-modal-overlay" @click.self="ui.showTripNameModal = false">
            <div class="glass-modal-content p-8">
                <h3 class="text-xl font-bold text-slate-700 mb-6 text-center">編輯行程名稱</h3>
                <input v-model="tempTripName" type="text" placeholder="輸入名稱" class="w-full text-center font-bold text-lg bg-white/50 p-4 rounded-2xl mb-6 border border-white shadow-sm" @keyup.enter="saveTripName">
                <div class="flex gap-3">
                    <button @click="ui.showTripNameModal = false" class="flex-1 py-4 rounded-2xl font-bold text-slate-400 bg-white/40">取消</button>
                    <button @click="saveTripName" class="flex-1 py-4 rounded-2xl font-bold text-white btn-primary">儲存</button>
                </div>
            </div>
        </div>

        <div v-if="modal.show" class="glass-modal-overlay" @click.self="modal.show = false">
            <div class="glass-modal-content p-8">
                <h3 class="text-xl font-bold text-slate-700 mb-6 text-center">{{ modal.title }}</h3>
                <input v-model="modal.inputValue" type="text" placeholder="輸入名稱..." class="w-full text-center font-bold text-lg bg-white/50 p-4 rounded-2xl mb-6 border border-white shadow-sm" @keyup.enter="confirmModal">
                <div class="flex gap-3">
                    <button @click="modal.show = false" class="flex-1 py-4 rounded-2xl font-bold text-slate-400 bg-white/40">取消</button>
                    <button @click="confirmModal" class="flex-1 py-4 rounded-2xl font-bold text-white btn-primary">確定</button>
                </div>
            </div>
        </div>

        <div v-if="mediaModal.show" class="glass-modal-overlay" @click.self="mediaModal.show = false">
            <div class="glass-modal-content">
                <div class="p-8 flex justify-between items-center border-b border-white/50">
                    <div>
                        <h3 class="text-xl font-bold text-slate-700">附件與連結</h3>
                        <p class="text-[10px] text-morandi-main font-bold mt-1">{{ mediaModal.target.loc || '未命名地點' }}</p>
                    </div>
                    <button @click="mediaModal.show = false" class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-slate-400"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 no-scrollbar space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">參考照片</label>
                            <button @click="triggerFile" class="text-[10px] bg-white border border-morandi-light text-morandi-dark px-3 py-1.5 rounded-xl font-bold shadow-sm">+ 新增</button>
                            <input id="media-file-input" type="file" accept="image/*" class="hidden" @change="handleFileUpload">
                        </div>
                        <div class="space-y-4">
                            <div v-for="(p, idx) in mediaModal.target.photos" :key="idx" class="bg-white/60 rounded-3xl p-3 flex gap-4 shadow-sm border border-white">
                                <img :src="p.url" class="w-20 h-20 object-cover rounded-2xl shadow-inner bg-slate-100">
                                <div class="flex-1 flex flex-col justify-between">
                                    <input v-model="p.desc" type="text" placeholder="新增說明..." class="w-full text-xs font-medium bg-transparent border-b border-slate-100 py-1">
                                    <button @click="mediaModal.target.photos.splice(idx, 1)" class="text-[10px] text-red-300 self-end">移除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">參考連結</label>
                            <button @click="addLink" class="text-[10px] bg-white border border-morandi-light text-morandi-dark px-3 py-1.5 rounded-xl font-bold shadow-sm">+ 新增</button>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(l, idx) in mediaModal.target.links" :key="idx" class="bg-white/60 rounded-2xl p-4 border border-white shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <input v-model="l.name" type="text" placeholder="這是什麼" class="w-full text-xs font-bold text-slate-600 bg-transparent">
                                    <button @click="mediaModal.target.links.splice(idx, 1)" class="text-slate-300 ml-2"><i class="fas fa-trash-alt text-xs"></i></button>
                                </div>
                                <input v-model="l.url" type="text" placeholder="貼上網址..." class="w-full text-[10px] text-blue-400/70 italic bg-transparent">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-8"><button @click="mediaModal.show = false" class="w-full btn-primary py-4 rounded-2xl font-bold shadow-lg">完成</button></div>
            </div>
        </div>

        <div v-if="showWizard" class="fixed inset-0 z-[2000] bg-[#5b7482] flex flex-col items-center justify-center p-10 gap-6">
            <div class="text-white text-center mb-4"><i class="fas fa-compass text-6xl mb-4"></i><h2 class="text-3xl font-bold tracking-widest uppercase">LET'S GO</h2></div>
            <input v-model="trip.name" type="text" placeholder="行程名稱" class="w-full max-w-xs p-5 rounded-3xl bg-white text-center font-bold">
            <input id="wiz-date-range" type="text" placeholder="選擇日期" class="w-full max-w-xs p-5 rounded-3xl bg-white text-center font-bold" readonly>
            <button @click="startJourney" class="w-full max-w-xs bg-white text-[#5b7482] p-5 rounded-3xl font-black shadow-2xl">START</button>
        </div>

        <main v-if="!showWizard">
            <section v-show="activeTab === 'itinerary'" class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-700 mb-2">
                            {{ trip.name || '未命名行程' }}
                            <i @click="openTripNameModal" class="fas fa-pen-nib edit-icon"></i>
                        </h2>
                        <div class="date-adjust-bar shadow-sm" id="date-adjuster">
                            <i class="far fa-calendar-alt text-morandi-main text-xs"></i>
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">設定起始日: {{ formatDateLong(0) }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="sortItems" class="bg-white text-morandi p-3 rounded-2xl shadow-sm"><i class="fas fa-sort-amount-down-alt"></i></button>
                        <button @click="addDay" class="btn-primary px-5 py-3 rounded-2xl font-bold text-xs">+ 天數</button>
                    </div>
                </div>

                <div class="day-scroller no-scrollbar mb-8">
                    <div v-for="(day, index) in itineraries" :key="day.uid" class="day-tab group">
                        <button @click="currentDayIdx = index" 
                            :class="['px-7 py-4 rounded-[1.5rem] font-bold text-sm min-w-[120px] transition-all border-2 flex flex-col items-center justify-center', currentDayIdx === index ? 'bg-white border-morandi-main text-morandi shadow-md' : 'bg-transparent border-transparent text-slate-400']">
                            <span>DAY {{ index + 1 }}</span>
                            <span class="text-[10px] font-normal opacity-60 mt-1">{{ formatDateShort(index) }}</span>
                        </button>
                        <div v-if="itineraries.length > 1" @click.stop="removeDay(index)" class="day-delete opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></div>
                    </div>
                </div>

                <div id="items-list" class="space-y-5">
                    <div v-for="(item, idx) in (itineraries[currentDayIdx]?.items || [])" :key="item.uid" class="mist-card p-6 relative">
                        <div class="flex justify-between items-center mb-5">
                            <div class="flex items-center gap-2">
                                <div class="drag-handle"><i class="fas fa-bars"></i></div>
                                <input v-model="item.time" type="text" class="time-input font-bold text-morandi bg-slate-50 px-4 py-2 rounded-xl w-24 text-center" readonly>
                            </div>
                            <button @click="removeItem(idx)" class="text-slate-200 hover:text-red-300"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <div class="relative mb-3">
                            <input v-model="item.loc" type="text" placeholder="-ˋˏ ♡ ˎˊ- " class="w-full text-xl font-bold text-slate-700 pr-10 border-b border-transparent focus:border-slate-100 bg-transparent">
                            <i @click="openGoogleMap(item.loc)" class="fas fa-location-arrow absolute right-1 top-1 text-morandi-light"></i>
                        </div>
                        <textarea v-model="item.note" placeholder="備忘錄..." class="w-full text-sm text-slate-400 bg-slate-50/50 p-4 rounded-2xl resize-none min-h-[80px] border-none"></textarea>
                        
                        <div class="mt-4 flex justify-end">
                            <button @click="openMediaModal(item)" class="attachment-btn relative">
                                <i class="fas fa-paperclip text-sm"></i>
                                <div v-if="(item.photos?.length || 0) + (item.links?.length || 0) > 0" class="badge-dot"></div>
                            </button>
                        </div>
                    </div>
                    <button @click="addItem" class="w-full border-2 border-dashed border-morandi-light/40 p-10 rounded-[2.5rem] text-morandi-light font-bold">+ 加入行程</button>
                </div>
            </section>

            <section v-show="activeTab === 'wallet'" class="p-6">
                <h2 class="text-3xl font-bold mb-8 text-slate-700">是免稅不是免費</h2>
                <div class="mist-card p-7 mb-8">
                    <div class="flex gap-4 mb-6">
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">外幣種類</label>
                            <input type="text" v-model="currencySearch" placeholder="日本..." class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold border border-slate-100">
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">匯率</label>
                            <input type="number" v-model.number="currentRate" step="0.0001" class="w-full bg-slate-50 p-4 rounded-2xl text-morandi-dark font-bold border border-slate-100 text-center">
                        </div>
                    </div>
                    <div class="rounded-[2.5rem] p-8 text-white shadow-xl text-center" style="background-color: #5b7482;">
                        <div class="text-sm font-bold opacity-60 mb-2">預估台幣 NT$ {{ Math.round((foreignAmount || 0) * (currentRate || 1)).toLocaleString() }}</div>
                        <div class="flex items-center justify-center">
                            <span class="text-4xl font-light mr-4 opacity-50">{{ currencySymbol }}</span>
                            <input type="number" v-model.number="foreignAmount" inputmode="decimal" placeholder="0" class="text-5xl font-black w-full text-white bg-transparent text-center outline-none">
                        </div>
                    </div>
                </div>

                <div class="mist-card p-7 mb-8 flex items-center border-l-8 border-morandi-main">
                    <div class="w-1/2 border-r border-slate-100 pr-4">
                        <label class="text-[10px] text-morandi font-bold uppercase mb-2 block tracking-widest">散財童子</label>
                        <select v-model="budgetViewMode" class="w-full bg-slate-50 py-3 px-4 rounded-2xl text-sm font-black text-slate-600 appearance-none">
                            <option value="total">總支出</option>
                            <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                        </select>
                    </div>
                    <div class="w-1/2 text-right pl-4">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">{{ budgetViewMode === 'total' ? '總額' : '應付' }} ({{currencySymbol}})</p>
                        <p class="text-3xl font-black text-morandi-dark">{{ displayPaidAmount.toLocaleString(undefined, {maximumFractionDigits: 1}) }}</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-slate-500 tracking-widest">支出項目</h3>
                        <div class="flex gap-2">
                            <div class="relative">
                                <button @click.stop="ui.showMemberDropdown = !ui.showMemberDropdown" class="bg-white border border-slate-200 px-5 py-3 rounded-2xl text-slate-500 font-bold text-xs"><i class="fas fa-user-friends"></i> 旅伴</button>
                                <div v-if="ui.showMemberDropdown" class="absolute right-0 mt-3 w-56 bg-white rounded-[2rem] shadow-2xl z-[2000] border border-slate-100">
                                    <div v-for="(m, i) in members" :key="i" class="flex justify-between items-center p-4 hover:bg-slate-50 border-b border-slate-50">
                                        <span class="font-bold text-slate-600">{{ m }}</span>
                                        <div class="flex gap-3">
                                            <i @click.stop="openEditModal(i)" class="fas fa-edit text-slate-300"></i>
                                            <i v-if="members.length > 1" @click.stop="removeMember(i)" class="fas fa-trash-alt text-slate-200"></i>
                                        </div>
                                    </div>
                                    <button @click.stop="openAddModal(); ui.showMemberDropdown = false;" class="w-full p-4 btn-primary font-bold text-xs">+ 新增成員</button>
                                </div>
                            </div>
                            <button @click="addBill" class="btn-primary px-6 py-3 rounded-2xl font-bold text-xs">一直花錢錢</button>
                        </div>
                    </div>

                    <div v-for="(bill, bi) in bills" :key="bi" class="mist-card p-6 relative">
                        <div class="flex gap-4 mb-6">
                            <div class="w-1/4">
                                <label class="text-[10px] font-bold text-morandi-light block">天數</label>
                                <select v-model="bill.day" class="w-full bg-slate-50 rounded-xl p-3 text-xs font-black">
                                    <option v-for="(d, i) in itineraries" :value="i+1">D{{i+1}}</option>
                                </select>
                            </div>
                            <div class="w-2/4">
                                <label class="text-[10px] font-bold text-morandi-light block">項目</label>
                                <input v-model="bill.title" type="text" class="w-full font-bold text-slate-700 border-b border-slate-100 p-1 bg-transparent">
                            </div>
                            <div class="w-1/4">
                                <label class="text-[10px] font-bold text-morandi-dark block text-left">金額 ({{currencySymbol}})</label>
                                <input v-model.number="bill.amount" type="number" class="w-full font-black text-morandi-dark border-b border-morandi-light/30 p-1 text-right bg-transparent">
                            </div>
                        </div>
                        <div class="flex gap-5">
                            <div class="w-2/5">
                                <label class="text-[10px] font-bold text-morandi uppercase block mb-2">乾爹੭ ᐕ)੭ </label>
                                <select v-model="bill.payer" class="w-full bg-slate-100 rounded-2xl px-4 py-3 text-xs font-black appearance-none sync-height">
                                    <option v-for="m in members" :value="m">{{ m }}</option>
                                </select>
                            </div>
                            <div class="w-3/5">
                                <label class="text-[10px] font-bold text-morandi uppercase block mb-2">一起散財ˎ₍•ʚ•₎ˏ </label>
                                <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                    <button v-for="m in members" @click="toggleBillMember(bi, m)" :class="['split-btn', bill.splitWith.includes(m) ? 'split-active' : 'split-inactive']">{{ m }}</button>
                                </div>
                            </div>
                        </div>
                        <button @click="removeBill(bi)" class="absolute top-4 right-4 text-slate-200"><i class="fas fa-times-circle"></i></button>
                    </div>

                    <div v-if="settlement.length > 0" class="rounded-[3rem] p-10 text-white shadow-2xl mt-12 relative overflow-hidden" style="background-color: #5b7482;">
                        <h4 class="text-center font-black mb-8 text-xs opacity-40 uppercase tracking-[0.4em]">Settlement</h4>
                        <div class="space-y-4">
                            <div v-for="res in settlement" :key="res.from + res.to" class="flex justify-between items-center bg-white/10 p-6 rounded-3xl backdrop-blur-md">
                                <div class="flex items-center gap-4"><span class="text-xs font-bold text-white/70">{{ res.from }}</span><i class="fas fa-chevron-right text-white/20 text-[10px]"></i><span class="text-xs font-bold text-white">{{ res.to }}</span></div>
                                <div class="text-right">
                                    <div class="text-xl font-black">{{ currencySymbol }} {{ res.amount.toLocaleString(undefined, {maximumFractionDigits: 1}) }}</div>
                                    <div class="text-[10px] font-bold opacity-60">≈ NT$ {{ Math.round(res.amount * currentRate).toLocaleString() }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <nav v-if="!showWizard" class="fixed bottom-10 left-1/2 -translate-x-1/2 w-full max-w-xs nav-morandi rounded-[2.5rem] shadow-2xl px-8 py-5 z-[4000] flex justify-around items-center border border-white/10">
            <div @click="activeTab = 'itinerary'" :class="['flex flex-col items-center gap-1.5 cursor-pointer', activeTab === 'itinerary' ? 'text-white scale-110' : 'text-white/40']">
                <i class="fas fa-map-marked-alt text-xl"></i><span class="text-[9px] font-black uppercase tracking-widest">行程</span>
            </div>
            <div @click="activeTab = 'wallet'" :class="['flex flex-col items-center gap-1.5 cursor-pointer', activeTab === 'wallet' ? 'text-white scale-110' : 'text-white/40']">
                <i class="fas fa-wallet text-xl"></i><span class="text-[9px] font-black uppercase tracking-widest">錢包</span>
            </div>
        </nav>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { 
        getAuth, 
        signInWithRedirect, 
        GoogleAuthProvider, 
        onAuthStateChanged, 
        getRedirectResult 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxyJNRALZjiCQZWsRpU2tlRMfncEToDGo",
        authDomain: "aomori-trip-2026.firebaseapp.com",
        databaseURL: "https://aomori-trip-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "aomori-trip-2026",
        storageBucket: "aomori-trip-2026.firebasestorage.app",
        messagingSenderId: "647683108626",
        appId: "1:647683108626:web:5b47201d9771dbf0724dcb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    const { createApp, ref: vueRef, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            const currentUser = vueRef(null);
            const showWizard = vueRef(false); 
            const activeTab = vueRef('itinerary');
            const trip = reactive({ name: '' });
            const itineraries = vueRef([]);
            const currentDayIdx = vueRef(0);
            const members = vueRef(['我', '旅伴']);
            const bills = vueRef([]);
            const budgetViewMode = vueRef('total');
            const currencySearch = vueRef('日本');
            const currencySymbol = vueRef('¥');
            const currentRate = vueRef(0.215);
            const foreignAmount = vueRef(0);
            const tempTripName = vueRef('');

            const login = () => {
                signInWithRedirect(auth, provider);
            };

            const ui = reactive({ 
                isLoading: true, 
                showMemberDropdown: false, 
                showTripNameModal: false, 
                isIgnoreWatch: false 
            });
            const modal = reactive({ show: false, title: '', inputValue: '', type: '', editIndex: null });
            const mediaModal = reactive({ show: false, target: null });

            const generateUID = () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36);

            const updateAllDates = () => {
                if (itineraries.value.length === 0) return;
                const startDate = new Date(itineraries.value[0].date);
                itineraries.value.forEach((day, i) => {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    day.date = d.toISOString().split('T')[0];
                });
            };

            const initPickers = () => {
                nextTick(() => { 
                    flatpickr(".time-input", { 
                        enableTime: true, noCalendar: true, dateFormat: "H:i", 
                        time_24hr: true, disableMobile: true 
                    }); 
                    if (document.getElementById('wiz-date-range')) {
                        flatpickr("#wiz-date-range", { mode: "range", disableMobile: true });
                    }
                    const adj = document.getElementById('date-adjuster');
                    if(adj && itineraries.value[0]) {
                        flatpickr("#date-adjuster", {
                            dateFormat: "Y-m-d", disableMobile: true,
                            defaultDate: itineraries.value[0].date,
                            onChange: (s, dateStr) => { 
                                itineraries.value[0].date = dateStr; 
                                updateAllDates(); 
                            }
                        });
                    }
                });
            };

            let sortableInstance = null;
            const initSortable = () => {
                nextTick(() => {
                    const el = document.getElementById('items-list');
                    if (!el || activeTab.value !== 'itinerary') return;
                    if (sortableInstance) sortableInstance.destroy();
                    sortableInstance = new Sortable(el, { 
                        animation: 250, handle: '.drag-handle', ghostClass: 'sortable-ghost',
                        onEnd: (evt) => {
                            const items = [...itineraries.value[currentDayIdx.value].items];
                            const moved = items.splice(evt.oldIndex, 1)[0];
                            items.splice(evt.newIndex, 0, moved);
                            itineraries.value[currentDayIdx.value].items = items;
                        }
                    });
                });
            };

            const loadDataFromFirebase = () => {
                const tripRef = ref(db, 'trip_data_2026');
                onValue(tripRef, (snapshot) => {
                    const data = snapshot.val();
                    ui.isIgnoreWatch = true; 
                    if (data && data.itineraries && data.itineraries.length > 0) {
                        trip.name = data.trip?.name || '';
                        itineraries.value = data.itineraries;
                        members.value = data.members || ['我', '旅伴'];
                        bills.value = data.bills || [];
                        currentRate.value = data.currentRate || 0.215;
                        showWizard.value = false;
                    } else {
                        showWizard.value = true;
                    }
                    ui.isLoading = false; 
                    nextTick(() => { 
                        ui.isIgnoreWatch = false; 
                        initPickers(); 
                        initSortable(); 
                    });
                });
            };

            const displayPaidAmount = computed(() => {
                if (budgetViewMode.value === 'total') return bills.value.reduce((sum, b) => sum + (Number(b.amount) || 0), 0);
                return bills.value.reduce((sum, b) => {
                    const amt = Number(b.amount) || 0;
                    if (amt > 0 && b.splitWith.includes(budgetViewMode.value)) return sum + (amt / (b.splitWith.length || 1));
                    return sum;
                }, 0);
            });

            const settlement = computed(() => {
                const balances = {}; members.value.forEach(m => balances[m] = 0);
                bills.value.forEach(b => {
                    const amt = Number(b.amount) || 0; if (amt <= 0 || b.splitWith.length === 0) return;
                    const share = amt / b.splitWith.length; balances[b.payer] += amt;
                    b.splitWith.forEach(m => balances[m] -= share);
                });
                const trans = []; const d = [], c = [];
                for (let m in balances) {
                    if (balances[m] < -0.01) d.push({ n: m, v: -balances[m] });
                    else if (balances[m] > 0.01) c.push({ n: m, v: balances[m] });
                }
                let i = 0, j = 0;
                while (i < d.length && j < c.length) {
                    const s = Math.min(d[i].v, c[j].v); trans.push({ from: d[i].n, to: c[j].n, amount: s });
                    d[i].v -= s; c[j].v -= s; if (d[i].v < 0.01) i++; if (c[j].v < 0.01) j++;
                }
                return trans;
            });

            const getWeekDay = (dateStr) => ['日', '一', '二', '三', '四', '五', '六'][new Date(dateStr).getDay()];
            const formatDateShort = (i) => {
                if (!itineraries.value[i]) return '';
                const d = new Date(itineraries.value[i].date);
                return `${d.getMonth()+1}/${d.getDate()}(${getWeekDay(itineraries.value[i].date)})`;
            };
            const formatDateLong = (i) => itineraries.value[i] ? `${itineraries.value[i].date}(${getWeekDay(itineraries.value[i].date)})` : '';

            watch([activeTab, currentDayIdx], () => { 
                initSortable(); 
                initPickers(); 
            });

            watch(currencySearch, (v) => {
                const list = {'日本':0.215,'美':32.5,'韓':0.024,'泰':0.92,'歐':35.2};
                for(let k in list) { if(v.includes(k)) { currentRate.value=list[k]; currencySymbol.value=(k==='美'?'$':k==='韓'?'₩':k==='泰'?'฿':k==='歐'?'€':'¥'); break; }}
            });

            onMounted(() => {
                getRedirectResult(auth).then((result) => {
                        if (result?.user) {
                            currentUser.value = result.user;
                            loadDataFromFirebase();
                        }
                    }).catch((error) => {
                        console.error("登入跳轉錯誤:", error);
                    });
            
                onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser.value = user;
                            loadDataFromFirebase(); 
                        } else {
                            currentUser.value = null;
                            ui.isLoading = false; 
                        }
                    });
                });

            watch([trip, itineraries, members, bills, currentRate], () => {
                if (ui.isIgnoreWatch || ui.isLoading || !currentUser.value) return;
                const tripRef = ref(db, 'trip_data_2026');
                set(tripRef, {
                    trip: { name: trip.name },
                    itineraries: itineraries.value,
                    members: members.value,
                    bills: bills.value,
                    currentRate: currentRate.value
                });
            }, { deep: true });

            return {
                currentUser, login, showWizard, activeTab, trip, itineraries, currentDayIdx, members, bills, budgetViewMode,
                currencySearch, currencySymbol, currentRate, foreignAmount, displayPaidAmount, settlement, ui, modal,
                mediaModal, tempTripName, formatDateShort, formatDateLong,
                openTripNameModal: () => { tempTripName.value = trip.name; ui.showTripNameModal = true; },
                saveTripName: () => { trip.name = tempTripName.value; ui.showTripNameModal = false; },
                openMediaModal: (item) => { if(!item.photos) item.photos = []; if(!item.links) item.links = []; mediaModal.target = item; mediaModal.show = true; },
                triggerFile: () => document.getElementById('media-file-input').click(),
                handleFileUpload: (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => { mediaModal.target.photos.push({ url: ev.target.result, desc: '' }); e.target.value = ''; };
                    reader.readAsDataURL(file);
                },
                addLink: () => mediaModal.target.links.push({ name: '', url: '' }),
                startJourney: () => {
                    const val = document.getElementById('wiz-date-range').value; if(!val) return;
                    const startStr = val.split(" to ")[0];
                    const endStr = val.includes(" to ") ? val.split(" to ")[1] : startStr;
                    const start = new Date(startStr);
                    const end = new Date(endStr);
                    const diff = Math.ceil((end - start) / 86400000) + 1;
                    itineraries.value = Array.from({ length: diff }, (_, i) => {
                        const d = new Date(start); d.setDate(start.getDate() + i);
                        return { date: d.toISOString().split('T')[0], items: [], uid: generateUID() };
                    });
                    showWizard.value = false;
                    nextTick(() => { initPickers(); initSortable(); });
                },
                addDay: () => {
                    const lastDate = itineraries.value[itineraries.value.length - 1].date;
                    const nextDate = new Date(lastDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    itineraries.value.push({ date: nextDate.toISOString().split('T')[0], items: [], uid: generateUID() });
                    initPickers();
                },
                removeDay: (idx) => { if (confirm("刪除這天？")) { itineraries.value.splice(idx, 1); updateAllDates(); if(currentDayIdx.value >= itineraries.value.length) currentDayIdx.value = itineraries.value.length - 1; } },
                addItem: () => { 
                    if (!itineraries.value[currentDayIdx.value].items) itineraries.value[currentDayIdx.value].items = [];
                    itineraries.value[currentDayIdx.value].items.push({time:'09:00', loc:'', note:'', photos:[], links:[], uid: generateUID()}); 
                    initPickers(); 
                },
                removeItem: (idx) => itineraries.value[currentDayIdx.value].items.splice(idx,1),
                sortItems: () => { 
                    itineraries.value[currentDayIdx.value].items.sort((a,b) => a.time.localeCompare(b.time)); 
                    initPickers(); 
                },
                addBill: () => bills.value.push({ day: currentDayIdx.value+1, title: '', amount: 0, payer: members.value[0], splitWith: [...members.value] }),
                toggleBillMember: (bi, m) => { const l = bills.value[bi].splitWith; const i = l.indexOf(m); if(i > -1) l.splice(i,1); else l.push(m); },
                removeBill: (i) => bills.value.splice(i,1),
                removeMember: (i) => { if(confirm("移除成員？")) { members.value.splice(i,1); ui.showMemberDropdown = false; } },
                openAddModal: () => { modal.type='add'; modal.title='新增旅伴'; modal.inputValue=''; modal.show=true; },
                openEditModal: (i) => { modal.type='edit'; modal.editIndex=i; modal.title='編輯姓名'; modal.inputValue=members.value[i]; modal.show=true; },
                confirmModal: () => { if(modal.type==='add') { if(modal.inputValue) members.value.push(modal.inputValue); } else { members.value[modal.editIndex]=modal.inputValue; } modal.show=false; },
                openGoogleMap: (loc) => { 
                    if(loc) window.open(`http://googleusercontent.com/maps.google.com/?q=${encodeURIComponent(loc)}`, '_blank'); }
            };
        }
}).mount('#app');

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW error', err));
        });
    }
</script>
</body>
</html>